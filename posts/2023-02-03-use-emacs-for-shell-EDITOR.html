<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"class="no-webfont"><title>realazy: 作为命令行编辑器的 Emacs</title><meta charset="utf-8"><meta name="viewport"content="width=device-width,initial-scale=1,viewport-fit=cover"><link rel="alternate"href="https://feeds.feedburner.com/realazy"type="application/atom+xml"title="Realazy"><link rel="stylesheet"href="/assets/style.min.css"><body id="post"><header><h1><a href="/">真・懒</a></h1><section><span><a href="/feed.atom">订阅</a></span> <span><a href="https://twitter.com/_cxa">Twitter</a></span> <span><a href="https://github.com/cxa">GitHub</a></span> <span><a href="mailto:xianan.chen@gmail.com">联系</a></span></section></header><main><h1>作为命令行编辑器的 Emacs</h1><section class="meta"><time datetime="2023-02-03">二〇二三年二月三日</time></section><p>在终端编辑多行命令会非常不顺手和容易出错，此时你应该将 <code>EDITOR</code> 环境变量设置为你顺手的编辑器。起初我直接 <code>export EDITOR=emacs</code>，但这样会调起桌面端 Emacs 编辑器；然后我买了个乖 <code>export EDITOR=emacs -nw</code>，这样 Emacs 直接在终端启动了，但需从头到尾加载 Emacs 的配置，无论时间长短，打断感极强。好在 Emacs 提供 C/S 模式，即是说，配置加载只发生在 server 启动阶段，client 启动时间约等于连接 server 的时间，瞬间。<h2 id="server">启动 server</h2><p>启动 server 最简单的方式，是在终端输入 <code>emacs --daemon</code>，或者在已打开的 Emacs 编辑器内 <code>M-x server-start</code>。<p>如果需要随系统自启动，由于我用的是 macOS 系统，特别说明下该系统下的自启动方法：<ol><li>使用 <code>brew</code> 安装 <a href="https://github.com/d12frosted/homebrew-emacs-plus"><code>emacs-plus</code></a>，它附赠了 service：<code>brew services start emacs-plus@29</code>。（注意 <code>@29</code> 需更换为你所安装的版本)<li>开启 Script Editor（位于 <code>/Applications/Utilities/</code> 内，或用 Spotlight 搜索），新建文件，输入以下内容：<pre class="applescript"><code class="applescript">tell application &quot;Terminal&quot;
    do shell script &quot;/Applications/Emacs.app/Contents/MacOS/Emacs --daemon&quot;
end tell</code></pre>并保存为 <code>Application</code> 的文件格式。进入 <code>System Settings -&gt; General -&gt; Login Items</code>，将刚才保存的文件拖入 <code>Open at Login</code>。</ol><p>其他操作系统可参考：<a href="https://www.emacswiki.org/emacs/EmacsClient">https://www.emacswiki.org/emacs/EmacsClient</a>。<h2 id="client">启动 client</h2><p>在 <code>~/.zshrc</code>（如果你还用 <code>bash</code>，则是 <code>~/.profile</code>）中设置 <code>EDITOR</code>：<pre class="sh"><code class="sh">export EDITOR=&quot;emacsclient -a &#39;&#39; -c&quot;</code></pre><p>在终端中，编辑命令时，按 <code>C-x e</code> 就会调出 Emacs。如果上述一切准备就绪的话，Emacs 就会瞬间开启，没有任何配置加载过程。在开启的 Emacs 内编辑完毕，可按 <code>C-x #</code> 完成编辑返回到终端。<h2 id="">免应答优雅退出</h2><p><code>C-x #</code> 退出时，如果产生了编辑，Emacs 会询问是否保存。绝大部分情况下肯定都是编辑过，这个询问非常干扰多此一举。搜索一番并无定制的选项可禁止，只好自己去阅读下源码，看有没有解决方案。<p>首先，需要了解该快捷键调用了哪个方法。在 Emacs 中，可以在 <code>C-h k</code> 后键入 <code>C-x #</code> 一探究竟。一通操作猛如虎，最终发现在 <a href="https://github.com/emacs-mirror/emacs/blob/emacs-29/lisp/server.el#L1626">https://github.com/emacs-mirror/emacs/blob/emacs-29/lisp/server.el#L1626</a> 中执行了 <code>y-or-n-p</code> 这个询问函数。这里没有给任何的 hook，override 整个 <code>server-done</code> 显然是下下策。如果能在 <code>server-done</code> 内临时让 <code>y-or-n-p</code> 返回 <code>t</code> 就能皆大欢喜了。我的解决方案如下：<pre class="elisp"><code class="elisp">(defun cxa/yes-never-no (&amp;rest _args)
  &quot;Override `y-or-n-p&#39; to always retrun t.&quot;
  t)

(defun cxa/yes-then-restore (orig-fun &amp;rest args)
  &quot;Make `y-or-n-p&#39; always return t before ORIG-FUN, and restore after applied ARGS.&quot;
  (advice-add &#39;y-or-n-p :override &#39;cxa/yes-never-no)
  (apply orig-fun args)
  (advice-remove &#39;y-or-n-p &#39;cxa/yes-never-no))

(advice-add &#39;server-done :around &#39;cxa/yes-then-restore)</code></pre><p>代码即解释。如果是首次加入这段配置，记得重启 Emacs server。</main><footer><div class="intro"><img src="/assets/avatar.png"alt="头像"width="128"><p>我是陈贤安，喜欢钻研构建程序介面的技术，偏好静态类型函数式编程。常用编程语言有 JavaScript，会使 Swift、Objective-C、F# 和 OCaml。能看懂 C。realazy, 意取「真懒」，因为我相信，懒，对程序员来说，是一种美德。</div><p>2005 ～ 2023 © <span><a href="/">realazy</a></span> <span><a href="https://github.com/cxa/cxa.github.com.git">本站源码</a></span></footer><script src="/assets/highlight.js"></script><script src="/assets/script.js"></script>