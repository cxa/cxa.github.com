<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"class="no-webfont"><title>realazy: 记一款小工具的诞生</title><meta charset="utf-8"><meta name="viewport"content="width=device-width,initial-scale=1,viewport-fit=cover"><link rel="alternate"href="https://feeds.feedburner.com/realazy"type="application/atom+xml"title="Realazy"><link rel="stylesheet"href="/assets/style.min.css"><body id="post"><header><h1><a href="/">真・懒</a></h1><section><span><a href="/feed.atom">订阅</a></span> <span><a href="https://twitter.com/_cxa">Twitter</a></span> <span><a href="https://github.com/cxa">GitHub</a></span> <span><a href="mailto:xianan.chen@gmail.com">联系</a></span></section></header><main><h1>记一款小工具的诞生</h1><section class="meta"><time datetime="2021-01-13">二〇二一年一月十三日</time></section><p>我用 <a href="https://calibre-ebook.com">Calibre</a> 管理电子书籍已有很多年。它推出阅读器也有一段时间了，虽然没有 iBooks 那么美观，但胜在方便，而且直接支持 mobi 格式，渐渐我就用它替换了 iBooks。<p>Calibre 阅读器并非 native 的实现，选择文本后无法使用 macOS 的系统字典进行查询，也无法通过 PopClip 这种工具来转接。但它提供了一个自定义词典功能，可以通过 HTTP 地址进行查询。虽然有很多选择，但我最想用的还是系统字典。那么，能够通过 HTTP 查询系统字典，是我想做到的。<h2 id="">调研</h2><p>一番搜索，<code>Core Services</code> 的 <code>Dictionary Services</code> 提供了查询接口，遗憾的是功能有限，没有能覆盖到 <code>Dictionary.app</code> 提供的功能。然而，API 是藏不住的，<a href="https://nshipster.com/dictionary-services/">https://nshipster.com/dictionary-services/</a> 提供了这些私有接口。<p>一开始我想直接创建一个原生应用程序提供 HTTP 服务，但仔细看 API，它的输出有纯文本，也有 HTML (带 CSS 或者不带)。既然有纯文本，做成一个命令行工具，用途可以更宽广。然后再通过 Node 简单封装一下 HTTP 服务，开发效率会高很多。<h2 id="">实现</h2><h3 id="">命令行工具</h3><p>我一直希望能脱离 Xcode 用 <code>make</code> 来管理一下项目，这个小项目正是一个好机会。<code>Core Services</code> 类型都是 <code>Core Foundation</code> 类型，我也决定不用 ObjC，用纯 C 来练练手。<p>最终我把它命名为 <code>dicmd</code>，开源在 <a href="https://github.com/cxa/dicmd">https://github.com/cxa/dicmd</a>。为了方便安装，学会了简单的 <a href="https://github.com/cxa/homebrew-formulae/blob/main/dicmd.rb">homebrew formulae</a>。<h3 id="HTTP">HTTP 服务</h3><p>我选择了简单直接的 <a href="https://github.com/vercel/micro">micro</a>，这个倒没有什么好说。难点在于，词条的输出就是一个完整的 HTML 文档，如何将多词条拼凑在同一个页面。iframe 并不能自适应尺寸，<a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM">Shadow DOM</a> 是一个优雅的解决方案。具体可参考 <code>dicsrv</code>，开源在 <a href="https://github.com/cxa/dicsrv">https://github.com/cxa/dicsrv</a>。<h2 id="">效果</h2><p>如图。<p><img src="/assets/posts/2021_01_13_sample.png"alt="Screen shot"></main><footer><div class="intro"><img src="/assets/avatar.png"alt="头像"width="128"><p>我是陈贤安，喜欢钻研构建程序介面的技术，偏好静态类型函数式编程。常用编程语言有 JavaScript，会使 Swift、Objective-C、F# 和 OCaml。能看懂 C。realazy, 意取「真懒」，因为我相信，懒，对程序员来说，是一种美德。</div><p>2005 ～ 2023 © <span><a href="/">realazy</a></span> <span><a href="https://github.com/cxa/cxa.github.com.git">本站源码</a></span></footer><script src="/assets/highlight.js"></script><script src="/assets/script.js"></script>